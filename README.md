# clash-verge&Flclash&mihomo.js 智能分流配置脚本 - 使用说明

## 📖 简介

clash-verge&flclash&mihomo.js` 是一个专为 mihomo（Clash 变种）设计的**智能分流配置脚本**。
singbox全自动节点分流管理插件.js是给singbox做的一个全自动管理节点的插件；
singbox全自动节点分流管理混入脚本.js是给singbox做的一个mixin配置混入脚本能实现节点的全自动节点的管理与分流。
上述三个脚本的逻辑与功能都是出自同源逻辑，只是针对各自的适用场景做了分别的优化与适配，。
它们都能够自动管理您的代理节点，根据网络质量、地理位置和访问需求，智能选择最佳节点，让您的网络访问更加流畅、稳定。

## ✨ 核心功能

### 1. 🤖 AI智能节点评分系统
- **自动评估节点质量**：脚本会持续监测每个节点的性能表现
- **多维度评分**：综合考虑延迟、丢包率、抖动、吞吐量等多个指标
- **智能预测**：基于历史数据预测节点未来表现，提前规避不稳定节点
- **自动优化**：根据实时网络状况动态调整节点评分权重

### 2. 🌍 地理感知路由
- **智能区域匹配**：自动识别目标网站的地理位置
- **就近选择节点**：优先选择与目标网站同区域的节点，降低延迟
- **多级降级策略**：当主要API不可用时，自动切换到备用方案
- **缓存优化**：缓存地理信息查询结果，减少重复请求

### 3. 🔄 自动节点切换
- **质量监控**：实时监控当前节点的网络质量
- **智能切换**：当节点质量低于阈值时，自动切换到更优节点
- **冷却机制**：防止频繁切换，确保网络稳定性
- **无缝体验**：切换过程对用户透明，不影响正常使用

### 4. 📊 多维度性能评估
脚本会从以下维度评估节点性能：
- **延迟（Latency）**：响应速度，越低越好
- **丢包率（Loss）**：数据包丢失比例，越低越好
- **抖动（Jitter）**：延迟波动，越小越稳定
- **吞吐量（Throughput）**：传输速度，越高越好
- **成功率（Success Rate）**：请求成功比例

### 5. 🎯 智能服务分流
脚本内置了丰富的服务分流规则，包括：
- **流媒体服务**：YouTube、Netflix、Disney+、HBO、Hulu、Prime Video 等
- **社交媒体**：Telegram、WhatsApp、Line、TikTok 等
- **办公服务**：Google、Microsoft、Apple、GitHub 等
- **游戏服务**：Steam、游戏专用节点
- **其他服务**：广告过滤、跟踪分析等

### 6. 🌏 地区代理组管理
自动将节点按地区分类：
- **香港（HK）**、**美国（US）**、**日本（JP）**、**韩国（KR）**
- **新加坡（SG）**、**台湾（TW）**、**英国（GB）**、**德国（DE）**
- **马来西亚（MY）**、**土耳其（TK）**、**中国大陆（CN）** 等

每个地区组会自动选择该地区内性能最佳的节点。

## 🚀 使用方法

### 基本使用

1. **将脚本添加到 mihomo 配置**
   - 在您的 mihomo 配置文件中，将 `clash-verge&flclash&mihomo.js` 作为脚本引用
   - 脚本会自动处理您的代理配置

2. **配置会自动应用**
   - 脚本会在后台自动运行
   - 首次运行时会预热节点（测试前10个节点）
   - 之后会根据网络状况自动调整

### 配置选项

脚本提供了丰富的配置选项，您可以根据需要调整：

#### 服务分流开关
在 `Config.ruleOptions` 中可以开启/关闭特定服务的分流：
```javascript
ruleOptions: {
  youtube: true,    // 开启 YouTube 分流
  netflix: true,    // 开启 Netflix 分流
  openai: true,     // 开启 AI 服务分流
  // ... 更多选项
}
```

#### 地区配置
在 `Config.regionOptions` 中可以调整地区相关设置：
- `ratioLimit`: 倍率限制（默认 2，即只选择 2 倍率及以下的节点）
- `excludeHighPercentage`: 是否排除高倍率节点

#### 性能阈值
脚本内置了多个性能阈值，您可以根据网络环境调整：
- `QUALITY_SCORE_THRESHOLD`: 质量分阈值（默认 30）
- `NODE_TEST_TIMEOUT`: 节点测试超时时间（默认 5000ms）

## 💡 工作原理

### 1. 节点评估流程
```
节点测试 → 收集指标 → AI评分 → 更新质量分 → 选择最佳节点
```

### 2. 智能选择流程
```
请求到达 → 识别目标地理位置 → 筛选同区域节点 → 
评估性能 → 选择最佳节点 → 执行代理
```

### 3. 自动切换流程
```
监控当前节点 → 质量低于阈值 → 触发切换 → 
选择新节点 → 应用切换（冷却期保护）
```

## 🎨 主要特性

### ✅ 自动化
- 无需手动干预，全自动运行
- 自动节点评估、自动切换、自动优化

### ✅ 智能化
- AI 评分系统，基于多维度数据预测节点表现
- 地理感知路由，自动选择最优路径

### ✅ 稳定性
- 完善的错误处理和降级策略
- 防止频繁切换的冷却机制
- 多级缓存优化

### ✅ 高效性
- LRU 缓存减少重复计算
- 并发控制优化性能
- 按需清理缓存，节省资源

### ✅ 兼容性
- 支持浏览器和 Node.js 环境
- 完善的平台检测和降级策略

## 📈 性能优化

脚本采用了多项性能优化技术：

1. **智能缓存**：使用 LRU 缓存存储节点测试结果和地理信息
2. **并发控制**：限制并发测试数量，避免资源耗尽
3. **按需清理**：仅在缓存使用率超过阈值时清理，而非每次操作都清理
4. **批量处理**：批量评估节点，提高效率

## 🔧 高级功能

### 节点预热
脚本启动时会自动预热前 10 个节点，提前评估其性能，加快首次使用速度。

### 历史记录
脚本会记录每个节点的历史表现，用于：
- 趋势分析
- 质量预测
- 智能评分

### 成功率跟踪
为每个节点维护独立的成功率跟踪器，更准确地评估节点可靠性。

### 自动清理
自动清理长时间未评估或质量过低的节点，保持节点列表的整洁。

## ⚙️ 技术细节

### 事件驱动架构
脚本采用事件驱动机制，响应以下事件：
- 配置变更
- 网络恢复
- 性能阈值突破
- 评估完成

### 数据持久化
节点评估数据会自动保存到持久化存储，重启后可以继续使用历史数据。

### 多平台支持
- 支持 `$persistentStore`（Surge/Quantumult X 环境）
- 支持 `localStorage`（浏览器环境）
- 自动检测并适配

## 📝 注意事项

1. **首次运行**：脚本首次运行时会进行节点预热，可能需要一些时间
2. **网络环境**：确保网络连接正常，以便脚本能够测试节点和查询地理信息
3. **节点质量**：脚本会自动淘汰质量过低的节点，这是正常行为
4. **配置修改**：修改配置后，脚本会自动重新评估节点

## 🐛 常见问题

### Q: 脚本运行后没有效果？
A: 请检查：
- 脚本是否正确添加到 mihomo 配置
- 网络连接是否正常
- 查看日志输出，确认是否有错误信息

### Q: 节点切换太频繁？
A: 脚本内置了冷却机制，如果仍然频繁切换，可能是节点质量确实不稳定。可以尝试：
- 检查节点提供商的服务质量
- 调整 `QUALITY_SCORE_THRESHOLD` 阈值

### Q: 如何查看节点评分？
A: 在脚本中设置 `ENABLE_SCORE_DEBUGGING: true` 可以启用调试日志，查看详细的评分信息。

## 📚 相关资源

- **mihomo**：https://github.com/MetaCubeX/mihomo
- **Clash 文档**：https://clash.gitbook.io/

## 🔄 更新日志

脚本持续优化中，主要改进包括：
- ✅ 优化缓存清理策略
- ✅ 增强错误处理机制
- ✅ 改进 AI 评分算法
- ✅ 完善地理信息查询
- ✅ 提升多平台兼容性

## 📄 许可证

本脚本遵循相应的开源许可证。

---

**提示**：本脚本为自动化工具，建议在理解其工作原理后再进行高级配置修改。如有问题，请查看日志输出或联系技术支持。





